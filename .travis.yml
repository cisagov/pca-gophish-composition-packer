---
dist: xenial
language: python
python: 3.7
# pre-commit hooks can use Docker, so we should go ahead and enable it
services: docker
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "gehBfc/5OdhA5btSFzg+dFObDgnDGxnReHwe9yUZdy5JS0QQIVyXu8tz\
    MIsQ/vpGRHGLdcGujGg5+RULDKq92wvKTPaBXONkBtZkjAV1o0LaLygPx/9Wji/BmlE\
    Yc0NMqBy5VWJPhhHNBKxyTt1O0SsrGOP3nnZiDSJhOaEZYOR15QRWZbFvUU3Zpu8qt8\
    Bobx5FjB6+2hUuT8kEzR0zN9NjU3/i5v8KaB1yBEFQJQXIXb6bKDoNsqnrmNM0b8EEc\
    a985Mgtwu4Cp95sCnRy3h8UcHcd2WE29Y4d8CC/pewFaPI9kX+9bPpswARQPLniERzH\
    TB2YEwgmYyWibC5ipcv3ON46JIOHLaYL7uPhI718W1lhE9sIApUZQD5z9R/wYjUSE+a\
    6fBCs+9ieZV9w1Mr0AAIQDAm4u/JC5ASifVlurRd2vW75fg6UKefSa/DuGv1JfvXPst\
    kRcwSz5+pM7FYh7e5e/ThKJk0KmCz+MtGW0pozXxY6hqFBdx2LmZ49mARBr8mvmsML7\
    X+fCAAakMeMf/ntmZO2VEao8p6eZi1N40fZ1anzfTcljHRbDZOsgFwfeVap6KlVjfUE\
    4fLSNPzh2nGhCFxhxIr1FmIM9LD7TuXnTtrKF8o2OhyH9N5OiI/Mpb+ZuxN8jAQUOpG\
    HOEHSwBlW4TmwUXTnHkA9BYQ="
    - AWS_DEFAULT_REGION="us-east-2"
    # AWS_SECRET_ACCESS_KEY
    - secure: "xl4fJL6Xr9j13On7XDH8/v4Md26c5GDL0bZrVQHQbWt8BbfYP3IO2w69\
    /fjlkMYLuPwgWQot44zXY1akgjOq5aOTqwXybHX4CLz/xWYcZZVOCBp91Kf1bfxMo3Y\
    TJ8EWI5tbS9PdPw0GZjYQ1YYdnX5OV9+VyYMVsbFB8vvH/N/UYB0hxCm+aRZ+/8s3io\
    EGTvSLTqEsJuUmTOcQNH7oahtY+Zv7VdwVnXAQmaQKVXgfMxgxeMMnbk0rNcAXik3jb\
    vj775NA+qE8tCdPtPutYiJy6+xGbQI3kNIbgGBjgGM4SuWTXkis/KNRnpZHCB7bBCan\
    oHgU7Jyus2HBV7ECpIHKpZOFUfWdDUZt0SP8WHMaZxz3xVGqPr9KMTeQHDZ/amh0P8Z\
    B4GvH/XtJZmLa/Za+C7cLFiU/9HAcOS/DIHJ51dHz8+uGjGVcfAzUUvNqi9LpnjG5ld\
    u4urAC38+lh0KNd7CH35WDQjenZ1Ti6MFzQFDAyFXlcjbHroOl0MOCPb7CQ2LTv4GEL\
    4SlrMLA/vrasKkRzn8Y7YBTurCBychkonFe1bBfLkAikG/RrL6+oqmK6qJz7QF2DfgR\
    D06VRI+21wFa3Raikv6O4AEcd+MFjNpLdqrVortNj3V3ufHvHfxKgS8souPmfW1rLcF\
    Z9xhv7GQ6S00KGjI3u2JtkLU="
    - PACKER_BUILD_REGION="us-east-2"
    - PACKER_DEPLOY_REGIONS="us-east-1,us-west-1,us-west-2"
    - PACKER_VERSION="1.4.2"
    - TERRAFORM_VERSION="0.12.3"


# Cache pip packages and pre-commit plugins to speed up builds
cache:
  pip: true
  directories:
    - $HOME/.cache/pre-commit

before_install:
  # Install terraform
  - >
    wget
    https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
    -O /tmp/terraform.zip
  - sudo unzip -d /opt/terraform /tmp/terraform.zip
  - sudo ln -s /opt/terraform/terraform /usr/bin/terraform
  # install packer
  - curl --output /tmp/packer.zip --location
      "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip"
  - sudo unzip -o -d /usr/local/bin /tmp/packer.zip

install:
  - pip install --upgrade --requirement requirements-test.txt
  - export PACKER_IMAGE_VERSION=$(./bump_version.sh show)
  - eval $(./update_env.py)
  # install roles
  - ansible-galaxy install --force --role-file src/requirements.yml

script:
  - pre-commit run --all-files
  - packer validate src/packer.json
  - pytest

deploy:
  # create a production image
  - provider: script
    script: packer build --timestamp-ui src/packer.json
    on:
      tags: true
